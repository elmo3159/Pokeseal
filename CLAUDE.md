# ポケシル（Pokeseal）- モバイルアプリ実装仕様書（Web技術ベース）

## ClaudeCode + TypeScript / React / Next.js 向け 完全実装ガイド

---

## 0. ClaudeCode 自律開発ルール（最重要）

### 0.1 基本行動原則

ClaudeCode は本仕様書に従い、常に次を守って開発を行う。

* すべてのタスクは「動くところまで」必ず完了させる

  * 型エラー・Lint エラー・ビルドエラーを残さない
  * 画面ごとに最低限の動作確認まで行う
* 実装前に必ず簡単な計画を立て、作業ステップを整理してからコード生成する
* エラーが発生したら、自分で原因調査と修正を試みる

  * ログ・ブラウザコンソール・型エラーを読み、再生成で修正
* UI を作成・変更したら、ブラウザで見た目を必ず確認し、スクリーンショットを取得
* 大きな機能の前後で `git` コミットを行い、差分を小さく保つ（GitHub MCPで操作）
* バックエンド変更時は Supabase のダッシュボードと実際の API 動作で整合性を確認する

### 0.2 Web フロントエンド開発の標準パターン

本プロジェクトは **Next.js（App Router） + TypeScript + React** を前提とする。

#### 0.2.1 画面（ページ）実装パターン

1. 画面の目的・要素を簡単に箇条書きで整理する
2. `app/` 以下に画面用のルーティングを追加する（例：`/`, `/collection`, `/trade`, `/timeline`, `/profile`）
3. UI コンポーネントは `src/components/` 以下で細かく分割して作成する
4. レイアウトは Flexbox（または CSS グリッド）を用い、**スマホ縦画面（1080×1920 相当）を最優先**で設計する
5. カラーパレットや余白は、デザインシステム（0.7）にしたがって CSS（またはスタイルユーティリティ）で統一する
6. 新しいコンポーネントを作成したら、Storybook または画面上で見た目を確認し、基本的なインタラクションをテストする

#### 0.2.2 StPageFlip（page-flip） を用いた 3D 風シール帳

1. シール帳は `BookView` という専用コンポーネントで表現する
2. `BookView` 内部で StPageFlip のインスタンスを生成し、

   * 表紙・裏表紙・各ページを DOM 要素として登録
   * 指・マウスドラッグでのページめくりを有効化する
3. ページ内容は通常の HTML / React コンポーネントで構成し、**シールは DOM 要素として配置**する
4. ページめくりイベントとアニメーション完了イベントをハンドリングし、

   * 現在ページ番号
   * ページ遷移に応じた UI 状態（ボタンの有効 / 無効など）
     を更新する
5. モバイル端末（タッチ）と PC（マウス）の両方で自然な操作ができるよう、StPageFlip の設定を調整する

#### 0.2.3 スクリプト・ロジック実装パターン

* すべて TypeScript で記述する
* ビジネスロジックやデータ操作は `src/domain/` や `src/services/` に分離し、UI から直接 API を呼ばない
* React コンポーネントは以下を意識する

  * UI 用の薄いコンポーネント（Presentational）
  * 状態・データ取得を担当するコンテナ（Hooks / Context）
* Supabase との通信は専用のクライアントモジュール経由で行い、API キーなどの機密情報は**環境変数で管理**する（仕様書に直接書かない）

#### 0.2.4 テスト・検証

* 主要なビジネスロジックはユニットテスト（Jest 等）でカバーする
* 重要なユーザーフロー（ガチャ・交換成立など）は簡易 E2E テスト（Playwright / Cypress 等）で確認する
* Lint（ESLint）・フォーマッタ（Prettier）は常に通る状態を保つ

### 0.3 ディレクトリ構成（推奨）

フロントエンド：

* `app/` : Next.js App Router のルート構成
* `src/components/` : 再利用可能な UI コンポーネント
* `src/features/` : 機能単位（sticker-book, gacha, trade, timeline など）の UI＋ロジック
* `src/domain/` : ドメインモデル、型定義
* `src/services/` : Supabase など外部サービスとのやり取りロジック
* `src/styles/` : グローバルスタイル、テーマ、CSS 変数定義
* `public/` : 画像、アイコンなどの静的アセット

バックエンド（Supabase）については Supabase プロジェクト側でテーブル・ポリシーを管理し、
アプリ側からは Supabase SDK 経由で操作する。

### 0.4 MCP 使用指針（Web プロジェクト向け）

利用する MCP サーバー：

* Supabase MCP：データベース操作・スキーマ確認
* filesystem MCP：ローカルのソースコード読み書き
* Desktop Commander：ブラウザの起動・スクリーンショット取得
* GitHub MCP：リポジトリのクローン、コミット、プッシュ
* Context7 MCP：外部ライブラリのドキュメント参照
* serena MCP：コードのリファクタリング支援、依存関係把握
* stability.ai MCP：画像生成（シール、アイコンなどの素材検討用）

基本方針：

* 新しいファイルを作成する際は filesystem MCP で作成し、内容を反映させる
* 大きな変更の前後で GitHub MCP を用いてコミット・プッシュを行う
* Supabase のテーブル定義やポリシー操作は Supabase MCP から SQL / GUI を用いて行う
* ブラウザ表示確認やスクショ取得は Desktop Commander で自動化できる範囲を利用する

### 0.5 エラー発生時の対処フロー

1. ブラウザコンソール・ターミナル出力・TypeScript エラーを確認
2. 関連ファイルを読み込み、原因となる箇所を特定
3. 型定義・ロジック・依存関係を修正
4. 再ビルド・再実行し、エラーが解消されるまで繰り返す
5. 同じ種類のバグが起きないよう、必要に応じてテストを追加

### 0.6 タスク完了の定義

* TypeScript のコンパイルエラーがない
* ESLint / Prettier が通っている
* ブラウザで画面が期待通りに表示され、主要なボタン・操作が機能する
* Supabase との通信が成功し、データが正しく永続化される
* 重要なフロー（例：1回ガチャを引く・1回交換を成立させる）が実際に通る

---

## 0.7 UI デザインシステム（モバイルアプリ（Web技術ベース））

これまでの Unity 向けデザインシステムを、そのまま Web 用 CSS に読み替えて用いる。

### 0.7.1 カラーパレット

* Primary：#6B3FA0（紫・メインボタン、タイトル）
* Secondary：#9B6FD0（薄紫・サブテキスト・枠線）
* Accent：#FFB6C1（ピンク・通知バッジ・強調）
* Background：#FFF5F8（薄ピンク・画面背景）
* Surface：#FFFFFF（白・カード、パネル）
* Text Primary：#4A2068（濃い紫・見出し）
* Text Secondary：#7A5090（中紫・本文）
* Success：#4CAF50（緑・成功メッセージ）
* Warning：#FFC107（黄・警告）
* Error：#F44336（赤・エラー）

CSS ではこれらをカスタムプロパティ（変数）として定義し、
コンポーネント側では変数経由で参照する。

### 0.7.2 タイポグラフィ

* Title Large：48px 太字、色は Text Primary
* Title Medium：36px 太字
* Title Small：28px 太字
* Body Large：24px 標準
* Body Medium：20px 標準
* Body Small：16px 標準
* Caption：14px 標準
* Button テキスト：24px 太字、色は白または Primary

### 0.7.3 スペーシング

* XS：8px（アイコンとテキストの間など）
* S：16px（ボタン内パディング）
* M：24px（コンポーネント間）
* L：32px（セクション間）
* XL：48px（画面端のマージン）
* XXL：64px（大きな区切り）

### 0.7.4 コンポーネント規格（Web UI）

ボタン・カード等は CSS クラスで統一スタイルを持たせる。

* プライマリボタン

  * 横幅：デバイス幅に応じて最小 150〜300px
  * 高さ：50〜80px
  * 背景色：Primary
  * 文字色：白
  * 角丸：12px
* セカンダリボタン

  * 背景：透明
  * 枠線：Primary 色 2px
  * テキスト：Primary
* アイコンボタン

  * 正方形 64〜80px
  * アイコン画像を背景または `<img>` で表示
* カード（シールカード、投稿カードなど）

  * 背景：Surface
  * 角丸：16px
  * パディング：16px
  * 影：軽めのシャドウで浮いて見えるようにする

コンポーネント名・クラス名は、
画面名＋役割で一貫性を持たせる（例：`HomeStartButton`, `TradeMatchButton` など）。

---

## 0.8 UI 開発ワークフロー（React）

新しい画面やコンポーネントを追加する際の標準手順。

1. 画面の目的と主な要素を文章で整理する
2. 必要なコンポーネントを箇条書きする
3. `app/` のルート、`src/components/` の構成を決める
4. レイアウトとスタイルをデザインシステムに合わせて設計する
5. React コンポーネントとして実装し、モックデータで見た目を確認
6. Supabase と接続し、本物のデータで動かす
7. 最後にブラウザでスマホ幅にしてチェックする

---

## 0.9 MCP 活用ガイド（再定義）

* Supabase MCP：テーブル定義、RLS ポリシー、SQL クエリの生成・実行
* filesystem MCP：Next.js プロジェクト内のファイル作成・更新・削除
* Desktop Commander：開発中 Web アプリの表示・スクリーンショット
* GitHub MCP：ブランチ作成、コミット、Pull Request 下書き
* Context7 MCP：StPageFlip や Supabase SDK のドキュメント検索
* serena MCP：大規模リファクタリング、設計改善提案
* stability.ai MCP：シール用テクスチャ、アイコン、背景イラストの素案生成（ただし実プロダクトの権利要件に注意）

---

## 1. プロジェクト概要（モバイルアプリ（Web技術ベース））

### 1.1 アプリケーション名

* 日本語名：ポケシル（ポケットシールちょう）
* 英語名：Pocket Sticker Album
プラットフォーム：

iOS / Android モバイルアプリ

中身は TypeScript + React / Next.js で実装し、
ラッパー（WebView）経由で App Store / Google Play に配信する。

公開方法：

ブラウザで独立公開する Web サイトは作らない。

配布は Apple App Store / Google Play ストア のみ。

### 1.2 コンセプト

* 子どものころの「シール帳遊び」を、スマホでいつでもどこでも楽しめるデジタルサービス
* リアルなページめくりアニメーションで **3D 風シール帳** を操作し、

  * シールを集める
  * ページに貼る・はがす
  * SNS 的なタイムラインで自慢する
  * マッチングボタンでランダムなユーザーと出会い、シール交換でゆるく交流する
* 将来的に、シールの種類やイベントを継続的に追加して長く遊べるサービスとする

### 1.3 技術スタック（概要）

* フロント：Next.js（App Router）＋ React ＋ TypeScript
* UI：カスタム CSS / UI ライブラリ（必要に応じて）、StPageFlip によるページめくり表現
* バックエンド：Supabase（PostgreSQL / Auth / Realtime / Storage）
* リアルタイム通信：Supabase Realtime または WebSocket
* インフラ：Vercel 等のホスティング＋アプリストア向けラッパー

---

## 2. 技術スタック（詳細）

### 2.1 フロントエンド

* フレームワーク：Next.js（App Router）
* 言語：TypeScript
* 状態管理：React Hooks と Context を基本とし、必要なら軽量な状態管理ライブラリを追加
* ページめくり：StPageFlip（page-flip ライブラリ）
* ドラッグ＆ドロップ：ブラウザの Pointer API・Touch API をベースにした自前実装、または軽量ライブラリ
* スタイル：CSS Modules または CSS-in-JS（統一）

### 2.2 バックエンド

* Supabase（PostgreSQL）
* 認証：Supabase Auth（メール / SNS ログインなど、決定次第）
* ストレージ：シール画像やスクリーンショット保存
* Realtime：交換中画面やタイムライン更新をリアルタイム反映

### 2.3 MCP・周辺ツール

前述の MCP 群を利用し、ClaudeCode がローカル開発・リポジトリ管理・DB 管理まで一貫して操作できるようにする。

---

## 3. コア機能仕様（モバイルアプリ（Web技術ベース））

### 3.1 3D 風シール帳システム

#### 3.1.1 シール帳の表示

* 中央に StPageFlip を用いたシール帳ビューを配置
* 表紙・見開きページのレイアウトは、以下を基本とする：

  * 左ページ：飾りやテーマ要素
  * 右ページ：シールを貼るメインスペース
* シール帳全体に軽い傾きや影を付け、**3D 風の立体感**を CSS で演出する

#### 3.1.2 操作

* ページ端をタップ／ドラッグすると、StPageFlip のインタラクションでページがめくれる
* ドラッグの進行度に応じてめくれ具合が変化し、指を離した時点で

  * 一定以上進んでいれば次のページへ
  * 足りなければ元に戻る
* スワイプ操作でも前後ページに移動できる
* スマホのピンチ操作で、ページ全体を拡大／縮小表示できる（CSS transform 等）

### 3.2 リアルなページめくり表現

* StPageFlip のパラメータを調整し、以下を満たすようにする：

  * 紙のしなり感
  * めくりスピード
  * シャドウによる奥行き
* ページめくり中は、裏面に貼ったシールも薄く透けて見えるようにデザインする（単純に裏ページを描画しておく）
* ページ番号を UI 上部に表示し、現在位置を常に把握できるようにする

### 3.3 チャーム（装飾）

* シール帳の上部に、チャームをぶら下げたような UI を表示する
* Web では物理エンジンではなく、CSS アニメーションで「ゆらゆら揺れる」動きだけを表現する
* 複数のチャームデザインから選択でき、選択中チャームはユーザープロフィールに紐づけて保存する

### 3.4 シール操作システム

#### 3.4.1 シール選択・回転

* 画面下部に「所持シール一覧パネル」を表示

  * 横スクロールでシールを閲覧
  * レア度・シリーズでフィルタリング可能
* シールをタップすると「貼り付けモード」に入り、

  * シールが指先に追従して動く
  * 別の指操作または UI 操作で回転（スライダー／回転ボタン）
* 貼り付け前プレビューでは、透明度を少し下げて「まだ確定していない」状態を示す

#### 3.4.2 ドラッグ＆ドロップ貼り付け

* ページ上でドラッグした座標を、

  * ページ内ローカル座標（0〜1 の範囲）に変換して記録
* ドロップすると、その座標・回転・スケールを Supabase の `sticker_placements` テーブルに保存
* 貼り付け済みシールを長押しすると「編集モード」に入り、

  * 移動
  * 回転
  * 削除（手持ちへ戻す）
    が行える

#### 3.4.3 シールの種類表現

* ぷっくりシール：影・ハイライトを活かした PNG 画像とドロップシャドウで表現
* キラキラシール：オーバーレイ用のアニメーション背景を重ね、光が流れるように見せる
* 通常シール：平面的な画像

※ すべて Web の 2D 表現の範囲で完結させる。

---

## 4. SNS・コミュニティ機能（モバイルアプリ（Web技術ベース））

### 4.1 シール帳投稿機能

* 任意のページを「投稿」として公開できる
* 投稿内容：

  * ページのスクリーンショット（Canvas などでキャプチャ）
  * ページID・シール配置データ
  * キャプション
  * ハッシュタグ
  * 公開範囲（全体 / フレンドのみ）
* タイムライン画面では、最新投稿をカード形式で一覧表示
* 各投稿に対し以下のリアクションが可能：

  * ❤️ いいね
  * ✨ キラキラ
  * 🔥 ホット
  * 🩷 かわいい

### 4.2 フレンド・フォロー機能

* 気になるユーザーを「お気に入り」に追加できる
* 相互にお気に入り登録になると「シールフレンド」となり、

  * 直接交換申請
  * フレンド限定投稿の閲覧
    が可能になる
* タイムラインには、フレンドの活動（新シール獲得、投稿など）を優先的に表示する

### 4.3 コンテスト・ランキング

* 週替わりのお題ページ投稿コンテストを実施
* 投票数・リアクション数などでランキングを表示
* コンテスト入賞者には限定シールや称号を付与する

---

## 5. シール交換システム（マッチング機能込み）

### 5.1 マッチングボタンによるランダム交換

#### 5.1.1 マッチングフロー

1. 交換タブに「マッチング開始」ボタンを配置
2. ボタンを押すと、ユーザーは「マッチング待機キュー」に入る
3. Supabase Realtime またはサーバーサイドロジックで、待機中ユーザーをランダムに2人ずつマッチング
4. マッチング成立後、両者は「交換セッションルーム」に入室
5. ルームID と相手ユーザー情報がクライアントに通知される
6. 交換用 UI 画面に自動遷移

#### 5.1.2 マッチング UI の要件

* マッチング中はローディングアニメーションとキャンセルボタンを表示
* 一定時間内にマッチ相手が見つからない場合はタイムアウトメッセージを表示
* 将来的に、条件付きマッチング（レア度帯やシリーズ指定）も拡張可能な設計にする

### 5.2 交換セッション画面の表現

#### 5.2.1 画面レイアウト

* 中央に「自分のシール帳」と「相手のシール帳」が**向かい合うように**表示される

  * 自分側は下側、相手側は上側に配置し、相手側は上から見下ろすような縮小表示
* 画面左右に、それぞれの「シールリスト」パネルを表示

  * 自分が出せるシール
  * 相手が持っているシール（閲覧専用）
* 画面中央には「交換候補エリア」を設ける

  * ここに、お互いが「相手から欲しいシール」を置く

#### 5.2.2 操作フロー

1. 自分は、相手のシール帳／シールリストから「欲しいシール」をタップ

   * 選択したシールが、自分側の「希望スロット」に表示される
2. 相手も同様に、自分のシールから欲しいシールを選択
3. 両者の希望スロットはリアルタイムに同期され、

   * どのシールが交換候補に上がっているか双方に見える
4. スタンプによるコミュニケーションを行う：

   * 「🙏✨（お願い！）」
   * 「🤔💭（迷い中…）」
   * 「➕🌟（もう1枚足して）」
   * 「🎉🤝（OK！）」 など
5. 条件がまとまったら、お互いが「こうかんOK」ボタンを押す

   * 片方だけ OK では成立せず、両者が押した時点でサーバーが交換を確定

#### 5.2.3 交換成立処理

* 両者が OK を押したタイミングでサーバー側が以下を行う：

  * まだシールが他のトレードで消費されていないか確認
  * 交換に使用される `user_stickers` の所有者と状態を検証
  * 問題なければ、トランザクション内で双方の所有者を入れ替える
  * `trades`・`trade_items` テーブルに確定情報を保存
* クライアント側には「交換成立」アニメーションと、

  * 新しく手に入ったシールのハイライト表示
    を行う

### 5.3 フェアトレード・レート表示

* 各シールには「レート（価値）」が設定されている

  * レア度・人気度・流通量などを元に数値化
* 交換候補が選ばれる度に、

  * 自分が差し出すシール合計レート
  * 相手から受け取るシール合計レート
    をカラーバーや数値で表示
* 明らかに大きな差がある場合は、

  * 「この交換はかなり損をする可能性があります」
    など注意メッセージを表示しつつ、ユーザー判断で進められるようにする

---

## 6. ガチャ・排出レートシステム（レート連動）

### 6.1 ガチャの基本仕様

* シールは後から多数追加される前提のため、ガチャロジックは「マスターデータ＋レート」による拡張可能な仕組みとする
* ガチャ種別：

  * ノーマルガチャ（無料チケットまたはゲーム内通貨）
  * プレミアムガチャ（課金通貨）
  * イベント限定ガチャ
  * コラボガチャ

### 6.2 レートに基づく排出確率

* 各シールは `stickers` テーブルに「レート値」を持つ

  * 数字が**高いほど貴重**で、**排出確率は低くする**
* あるガチャに含まれるシール集合に対し、

  * 重み付きランダム抽選を行う
  * 重みは「1 / レート」や、適切な関数により定義
* レア度（★〜★★★★★）とレートが矛盾しないよう、

  * レア度ごとの期待出現割合も調整する

### 6.3 ガチャ演出

* Web では、3D ではなく CSS アニメーション＋画像で演出する
* レア度により演出の豪華さ・色合いを変える

  * ノーマル：シンプルなポップ
  * レア以上：光のエフェクトや虹色の演出
* ガチャ結果画面では、

  * 新規獲得シール
  * すでに持っていたシールかどうか（初ゲットマーク）
    を明確に表示する

---

## 7. やりこみ要素・実績・思い出機能

Unity 版仕様書の内容を踏まえ、Web でも同様に以下を実装する。

* 実績・称号：

  * シール収集数
  * 交換回数
  * フレンド数
  * コンテスト入賞回数 などに応じて称号を付与
* 交換履歴：

  * 誰とどのシールを交換したか
  * 日時
  * 相手のプロフィールリンク
* 初ゲットマーク：

  * 各シールについて、最初に入手した記録を残し、図鑑やコレクション画面で特別なマークを付ける

---

## 8. バックエンド設計（Supabase）

### 8.1 Supabase 連携方針

* クライアントから直接 Supabase SDK を利用する
* プロジェクト URL や API キーは**環境変数**で管理し、公開リポジトリに直書きしない
* 認証済みユーザーだけが自分のデータを操作できるよう、RLS（Row Level Security）を徹底する

### 8.2 テーブル設計

Unity 版で定義したテーブル構成（profiles, sticker_books, sticker_book_pages, stickers, user_stickers, sticker_placements, trades, trade_items, trade_messages, friendships, posts, reactions, charms, user_charms 等）は基本的にそのまま利用する。
モバイルアプリ（Web技術ベース）では、API からの利用形態だけを Next.js/TypeScript に合わせて整理する。

### 8.3 RLS ポリシー概要

* 自分のデータは自分だけが閲覧・更新可能
* 公開投稿は誰でも閲覧可
* フレンド限定投稿はフレンドのみ閲覧可
* 交換関連テーブルは、当事者二人のみアクセス可
* 必要に応じて Supabase MCP からポリシーを生成・調整する

### 8.4 リアルタイム機能

* 交換セッション用：

  * `trade_messages`、`trades` テーブルの変更を購読し、
  * スタンプ送信・交換候補更新・成立通知をリアルタイム反映
* タイムライン：

  * `posts` や `reactions` の新規作成を購読し、「最新」タブに即座に反映

---

## 9. 画面別 UI 詳細仕様（モバイルアプリ）
9.1 共通レイアウト・ナビゲーション
9.1.1 共通デザイン

画面背景色：Background (#FFF5F8)（全タブ共通）

画面上部は「トップバー」、中央が「コンテンツ領域」、下部は「タブバー」という3分割構成。

角丸・カード・ボタン・色は 0.7 のデザインシステムに従う。

端末の Safe Area を考慮し、タブバーやトップバーがかぶらないようにする。

9.1.2 タブ構成（下部タブバー）

画面最下部に常時表示。高さ 約 64–72px、背景 Surface。

タブは左から順に：

🏠 ホーム

🧾 コレクション

🎰 ガチャ

🤝 交換

🕒 タイムライン

👤 プロフィール

各タブはアイコン＋ラベル（10〜12px）。

選択中タブはアイコンとラベルを Primary 色に、下に太めのインジケータバー（3〜4px）を表示。

未選択タブは Text Secondary。

9.2 ホームタブ（3D風シール帳）
9.2.1 画面構成

トップバー（画面上部 高さ約 56–64px）

左：アプリロゴ小（または「ポケシル」のテキストロゴ）

中央：現在のシール帳名（例：「メインシール帳」）

右：

[本アイコン] シール帳切り替えボタン

[クエスチョンアイコン] チュートリアル開始ボタン

メインコンテンツ（中央エリア 高さの約 55〜60%）

画面中央に StPageFlip のシール帳ビュー。

シール帳は横長（見開き）が画面中央に来るように配置。

背景にほんのり影を付け、うっすら斜めに傾けて 3D 風に見せる。

左右端には半分見える「ページの端」を表示し、スワイプできることを視覚的に示す。

ページ番号表示を右上に小さく表示（例：「3 / 12」）。

下部操作パネル（シールトレイエリア 高さの約 30〜35%）

上部：ページ操作バー（横一列）

左：[ページ一覧アイコン] ページインデックスモーダル起動

中央：[テーマアイコン] シール帳テーマ変更ボタン

右：[カメラアイコン] 「画像として保存（エクスポート）」ボタン

中央：所持シールトレイ（横スクロール）

高さ 約 120〜160px

シールを丸 or 任意形のアイコンで並べる。

各シール右上にランクアイコン（星マーク＋エフェクト）を小さく表示。

トレイ最上部に検索バーとフィルタチップ列：

検索バー（虫眼鏡アイコン＋プレースホルダ「シール名で検索」）

下にタグチップ（「ゆめかわ」「レトロ」「★3以上」など）を横スクロールで表示。

9.2.2 主なボタン位置と動き

ページめくり：

ユーザーはシール帳の右端／左端をスワイプ。StPageFlip が反応。

シールの貼り付け：

下部トレイのシールをタップ → 画面中央に「仮配置状態」で出現し、指に追従。

ページ上でドラッグ＆ドロップ → 指を離すと確定。

貼り付け済みシールを「長押し」すると編集モード（枠＋回転ハンドル＋削除ボタン）。

チュートリアルボタン（トップバー右上？マーク）：

いつでもチュートリアルモードに入れる。最初の起動時は自動表示。

9.3 コレクションタブ（シール図鑑・ランク・ポイント）
9.3.1 画面構成

トップバー

左：タイトル「シールコレクション」

右：[フィルターアイコン]

フィルタ & 検索エリア（トップバー直下）

1行目：検索バー（幅 100%、虫眼鏡アイコン）

2行目：フィルタチップ行

「すべて」「★1〜★5」「シリーズ」「テーマタグ」

タップするとドロップダウン（モーダル）で詳細選択。

コレクショングリッド（中央～下部）

2〜3 列のグリッド表示。

各シールカード：

上：シール画像（ランクエフェクト反映）

左下：シール名（Body Small）

右下：レア度（★アイコン）

左上：ランクバッジ（「RANK 3」等）

画面下端までスクロール可能。

9.3.2 シール詳細モーダル

グリッドのシールをタップすると全画面モーダル。

上部：拡大シール（ランクエフェクト付き）

中央：

シール名、シリーズ、レア度、現在ランク

「累計獲得数：XX枚」

「次のランクまで：あとX枚」

下部：

「スターポイントに変える」ボタン（所持枚数が一定以上のときのみ有効）

補足テキスト

「ポイントに変えてもランクは下がりません」など明記。

モーダル右上に [×] 閉じる。

9.4 ガチャタブ
9.4.1 画面構成

トップバー

左：タイトル「ガチャ」

右：[履歴アイコン] → ガチャ履歴モーダル

メインコンテンツ（中央大部分）

中央にガチャマシーンのイラストカード（高さの 40〜50%）。

マシーンカードの下に、現在のガチャ種別名（例：「ゆめかわガチャ」）＋簡単な説明。

その下に「提供割合を見る」リンク（モーダルでレア度別・シール別の確率一覧）。

下部操作エリア

中央に大きなプライマリボタン：

文言：「1回引く（×1）」

すぐ下にセカンダリボタン「10連で引く（×10）」

ボタンの下に、所持通貨 / チケット情報（小さめテキスト）。

9.4.2 ガチャ結果画面

全画面オーバーレイ。

上部：演出エリア（光・キラキラ）

中央：獲得シール一覧

新規シールには「NEW」ラベル。

ランクMAX に達しているシールの場合：
「ランクは最大です！＋スターポイント 〇〇 GET」テキストとアイコンを表示。

下部：

左：戻る

右：もう一度引くボタン

9.5 交換タブ（フレンド交換＋ランダムマッチング）
9.5.1 交換ホーム画面（タブ押下時の最初の画面）

トップバー

左：タイトル「シール交換」

右：[ヘルプアイコン] 交換チュートリアルへのリンク

セグメント切り替え（トップバー直下）

水平方向に2つのタブ：

「フレンド交換」

「ランダムマッチング」

選択中のタブは強調表示。

フレンド交換タブ内容

上部：フレンド一覧（横スクロール）

各カード：アイコン＋名前＋「交換」ボタン。

中央：進行中の交換一覧（カード形式）

ステータス（交渉中 / 承認待ち / 成立など）

下部：過去の交換履歴へのリンク。

ランダムマッチングタブ内容

画面中央に大きなカード：

テキスト：「ランダムで誰かとマッチして交換を楽しもう！」

簡単な注意書き（セーフティ・マナー）。

カード下中央にプライマリボタン：

「マッチング開始」

下部に小さなリンク：

「マッチングの遊び方を見る」 → チュートリアルモーダル。

9.5.2 ランダムマッチング待機画面

フル画面オーバーレイ。

中央にアニメーション（ぐるぐる回るシール or シール帳）。

上部：テキスト「マッチング中…」

下部中央にセカンダリボタン「キャンセルして戻る」。

9.6 交換セッション画面（向かい合うシール帳）
9.6.1 レイアウト

トップバー

左：[戻る矢印] 交換キャンセル（確認ダイアログ付き）

中央：相手のユーザー名（例：「@user123」と交換中）

右：[通報アイコン] → 通報モーダル、[ブロックアイコン] → ブロック確認モーダル

メインエリア（上 60%）

上半分：相手のシール帳（縮小表示）

画面上部中央に、相手のシール帳がこちら向きに置かれているイメージ。

タップでページめくり・シール一覧を閲覧できるが、編集は不可。

中央部分：交換候補エリア

左右に 2カラム構成：

左：相手から欲しいシール（自分の希望）スロット

最大 〇枚（後でルール設定）。

空スロットには薄い枠＋「ここに相手のシールを置く」というガイドテキスト。

右：自分が差し出すシールスロット

同様に枠＋ガイドテキスト。

下半分：自分のシール帳

画面下部中央に自分のシール帳（通常より少し縮小）を表示。

タップでページを切り替えつつ、自分のシールを選択できる。

下部操作バー（画面下 15〜20%）

左：スタンプボタン（丸アイコン）

押すと画面下から「スタンプパレット」がせり上がってくる。

中央：フェアトレード情報バー（横長）

「あなたの出すシール：合計レート 120」

「相手からもらうシール：合計レート 140」

バランスが取れているとき緑、差が大きいとき黄色／赤表示。

右：大きめのプライマリボタン「こうかんOK」

自分が押すと「あなたは OK 済み」と表示が変わる。

相手も押した瞬間に交換成立アニメーション。

9.6.2 操作

自分／相手のシール帳をタップ → シール詳細 → 「交換候補に追加」ボタン

「交換候補に追加」されたシールは、それぞれ対応するスロットに表示。

スロットのシールをタップすると、「候補から外す」メニュー表示。

スタンプパレットには以下のような丸ボタンを横に並べる：

🙏✨ / 🤔💭 / ➕🌟 / 🎉🤝 / 😢💔 / ⭐⭐⭐

スタンプ送信時、画面中央上あたりにポップで浮かぶアニメーション。

9.7 タイムラインタブ
9.7.1 画面構成

トップバー

左：タイトル「タイムライン」

右：[フィルターアイコン]（全体 / フレンド / 自分）

投稿カード一覧（縦スクロール）

各カードの構成：

上部：ユーザーアイコン＋名前＋投稿時間

右上：[…] メニュー

「通報する」「ブロックする」「共有」など

中央：シール帳見開き画像（サムネイル）

その下：キャプション（2〜3行まで表示、続きは「もっと見る」）

下部：リアクションバー

❤️ / ✨ / 🔥 / 🩷 アイコン＋数

コメント数（後でコメント機能を入れる場合に備えて枠だけ用意しておく）

フローティング投稿ボタン

画面右下に丸い FAB（ピンク Accent）：

アイコン：＋ or ペンアイコン

テキストラベルなし（ツールチップやチュートリアルで説明）

タップすると「投稿作成モーダル」へ。

9.8 プロフィールタブ
9.8.1 画面構成

トップバー

左：タイトル「プロフィール」

右：[歯車アイコン] 設定画面へ

上部プロフィールカード

左：ユーザーアイコン（丸）

右：

表示名

@ユーザーID

称号（例：「シールコレクター」「レジェンドハンター」）

ステータスエリア

横並びの3〜4 カード：

所持シール数

コンプリート率

交換回数

フレンド数 など

メニューセクション（リスト形式）

「シール帳きせかえ」

タップでテーマ選択画面へ（19.7 の仕様）。

「アカウント・ログイン情報」

メール/パスワード・SNS連携状況表示。

「セーフティ・ブロック管理」

ブロック中ユーザー一覧、解除ボタン。

「ヘルプ・チュートリアル」

チュートリアル再生・FAQ へのリンク。

「設定」

通知 ON/OFF 等。

9.9 チュートリアル・デモシール帳 UI
9.9.1 初回起動時のオーバーレイ

既存画面（主にホーム）を暗くして上にチュートリアルパネルを重ねる。

下部に「次へ」ボタン、左に「スキップ」リンク。

各ステップで、該当 UI 部分をハイライト（枠＋矢印）。

ステップ例：

ホームのシール帳を囲って「ここがあなたのシール帳だよ」

シールトレイを囲って「下のシールをドラッグして貼ってみよう」

ガチャタブを赤丸で強調「シールを増やしたくなったらここ」

交換タブの「マッチング開始」ボタンを強調「人と交換できるよ」

9.9.2 チュートリアル用デモシール帳

プロフィールタブ or ヘルプメニューから「デモシール帳を見る」ボタン。

押すと、読み取り専用のサンプルページがフル画面で表示。

下部に「自分のシール帳に戻る」ボタン。

9.10 セーフティ UI（通報・ブロック）
9.10.1 通報ボタンの配置

各ユーザープロフィール右上の [… メニュー] 内に「このユーザーを通報」。

タイムラインの投稿カードの [… メニュー] 内に「この投稿を通報」。

交換セッション画面トップバー右上に [通報アイコン]（旗マーク）。

通報モーダル：

上部に対象ユーザー／投稿の概要。

中央にカテゴリ選択（ラジオボタン）：スパム／不快な内容／その他。

下部に任意コメント欄。

下に「送信」プライマリボタン、「キャンセル」セカンダリボタン。

9.10.2 ブロックボタンの配置

同じく [… メニュー] 内に「このユーザーをブロック」。

交換セッション画面トップバー右上に [ブロックアイコン]（禁止マーク）も配置。

ブロック確認モーダル：

説明文：「このユーザーをブロックすると、マッチングや交換、投稿の表示などが制限されます。」

「ブロックする」／「キャンセル」ボタン。

9.11 シール帳テーマ／きせかえ UI
9.11.1 テーマ一覧画面（プロフィール > シール帳きせかえ）

上部：タイトル「シール帳きせかえ」

下にグリッドでテーマカードを一覧表示。

各カード：小さなシール帳サンプル画像＋テーマ名

未開放のテーマは鍵アイコン＋シルエット表示。

カードタップで右側に詳細パネル（またはモーダル）：

プレビュー画像

解放条件（ガチャ・イベント・スターポイント等）

「適用する」ボタン（開放済みのみ）

9.12 画像エクスポート UI
9.12.1 エクスポート操作

ホームタブのページ操作バー右側 [カメラアイコン]。

タップでモーダル：

タイトル：「画像として保存」

比率選択ボタン：

[ 正方形 (1:1) ]

[ 縦長 (9:16) ]

「ポケシルのロゴを入れる」チェックボックス（ON がデフォルト）

下部に「保存する」プライマリボタン。

処理完了後：

画面下部にトースト：「画像を保存しました」＋「共有する」ボタン（タップで OS の共有シート）。

---

## 10. 最適化・パフォーマンス

* 画像は WebP などの圧縮形式を採用し、必要以上に高解像度にしない
* 不要なライブラリを増やさず、バンドルサイズを抑える
* StPageFlip のページ数が増えすぎるとパフォーマンスに影響するため、

  * 必要なページのみインスタンスに読み込む
  * 非アクティブページの内容を遅延ロードする
* 交換セッションやリアルタイム更新では、サブスクライブするチャンネルを最小限に抑える

---

### 11. 通知

- 初期段階ではアプリ内通知（バナー・バッジ）を優先
- 将来的に、ラッパー経由で OS のプッシュ通知（Firebase / APNs 等）を導入する
- 通知対象：
  - 交換申請
  - 交換成立
  - フレンド申請
  - コンテスト開始／終了
  - ログインボーナス

---

## 12. ローカライゼーション

* 日本語をメインとし、テキストはすべて翻訳キーで管理
* Next.js 用の i18n ライブラリ（例：next-intl 等）を用いて、多言語対応しやすい構成にしておく
* 画像内テキストは避け、テキストは HTML レイヤーで表示

---

## 13. テスト方針

* ドメインロジック（ガチャ排出ロジック、レート計算、交換成立判定など）はユニットテストで検証
* 主要フロー（ログイン → ガチャ → シール貼り付け → マッチング交換成立）は E2E テストで確認
* パフォーマンステストとして、ページ数・シール数が多くなった状態でも操作感が保たれているかブラウザプロファイラで測定

---

## 14. ビルド・デプロイ・ラッパー

### 14.1 Web デプロイ（本番なし）

- 本番環境としてブラウザ公開用の URL は用意しない。
- Next.js は、`next export` などでビルドした静的アセット一式をラッパープロジェクト内に同梱して利用する。
- 開発中のみ、ローカル開発サーバー（`next dev`）で動作確認を行う。
- 必要であれば、開発者用の一時的なプレビュー環境として Vercel 等を使うが、一般ユーザー向けには公開しない。


### 14.2 ラッパーによるアプリストア配信

* Web アプリをラッパーツール（例：Capacitor や類似のソリューション）でネイティブアプリ化
* iOS / Android 向けにビルドし、

  * iOS App Store
  * Google Play
    などのアプリストアへの提出を行う
* ストア向けのアイコン・スプラッシュ画像・説明文などは別途用意

---

## 15. セキュリティ

* すべての API 通信は HTTPS 経由
* Supabase のキー類は環境変数で管理し、公開リポジトリに含めない
* RLS で不正なデータアクセスを防ぐ
* レート制限・不自然な交換やガチャ操作の検知ロジックを将来的に追加できるよう、ログを整備する

---

## 16. 開発フェーズ（モバイルアプリ（Web技術ベース））

Unity 版と同様に、以下のフェーズで進める。

1. 基盤構築：Next.js プロジェクトのセットアップ、Supabase 接続、認証
2. コア：3D 風シール帳表示、ページめくり、シール貼り付け、図鑑・ガチャ
3. 交換：マッチングボタン、交換セッション画面、レート表示、スタンプ交渉
4. SNS：投稿・タイムライン・リアクション・フレンド機能
5. 追加要素：コンテスト・ランキング・実績、パフォーマンス最適化
6. リリース準備：ラッパーによるアプリ化、ストア申請用素材作成、最終テスト

---

## 17. ClaudeCode への実装指示の考え方

* 新しい機能を作るときは、

  * 目的
  * 画面構成
  * 必要なデータ
  * ルーティング
    をまず自然言語で整理してから、ClaudeCode に「この仕様に従って Next.js / TypeScript で実装して」と依頼する。
* Supabase にテーブルを追加・変更する場合は、

  * 先に仕様書側のテーブル定義を更新
  * Supabase MCP でテーブル／ポリシーを作成
  * その後にフロントコードを更新
* 大きな変更ごとに GitHub MCP でブランチを切り、Pull Request 単位でまとめる。

---

## 18. 参考情報

* StPageFlip / page-flip の公式ドキュメントとデモを参照し、

  * 3D風ページめくりのパラメータ
  * スマホ対応
    を確認しながら実装する。
* Supabase 公式ドキュメントで、

  * Auth
  * Realtime
  * Storage
    を中心に参照し、Web フロントからの利用パターンを把握する。

---

以上が、Unity 仕様書をベースにした **TypeScript + React / Next.js + StPageFlip 版の完全仕様書**です。

この内容を前提に、ClaudeCode に
「まずは Next.js プロジェクトの雛形を作成し、3D風シール帳の最小プロトタイプ（ページめくり＋シール仮配置）まで実装して」
のように指示すると、かなりスムーズに動き出せるはずです。

19. 追加機能仕様
19.1 チュートリアル＋デモシール帳

目的
初回ユーザーが迷わず「何が楽しいアプリなのか」を理解し、1回目の体験で

ページめくり

シールを貼る

ガチャを引く

マッチング交換をしてみる
ところまで到達できることを目的とする。

要件

初回起動判定

ログイン直後、ユーザープロフィールに「チュートリアル完了フラグ」がなければチュートリアル開始。

チュートリアルは途中スキップ可能。ただしスキップ済みでも「ヘルプからいつでも再実行」できるようにする。

ストーリー仕立ての流れ

キャラクター（ナビゲーター）が登場し、ポケシルの世界観を一言で紹介。

「デモシール帳」を表示し、既にデコられた見開きページを見せてゴールイメージを伝える。

「ページめくり」を実演：

画面上に矢印やハイライトで「ここをスワイプしてね」を表示。

「シールを貼る」を実演：

指定シールを選ばせ、指定位置にドラッグして貼ってもらう。

「ガチャ」を1回体験させる：

チュートリアル専用の無料ガチャで、必ずかわいいシールが出るようにする。

「マッチング交換」のイメージ体験：

実ユーザーではなく「チュートリアル用ダミー相手」との交換フローを軽くなぞる。

実際の交換は行わず、演出のみで終了してもよい。

デモシール帳

運営が用意した「お手本ページ」を複数パターン用意し、チュートリアル内やヘルプ画面から閲覧可能にする。

デモページは編集不可。ユーザーのシール帳とは別扱いの読み取り専用データ。

19.2 セーフティ機能（子ども向け対策）

基本ポリシー

「自由テキストチャットは実装しない。コミュニケーションはスタンプと定型文のみ」と仕様書に明記する。

すべてのコミュニケーションは可視化・ログ化し、不適切な利用があれば運営が対応できるようにする。

機能要件

通報機能

各ユーザープロフィール・交換セッション・投稿には「通報」ボタンを設置。

通報時にカテゴリ選択（スパム／不快な行為／その他）と任意コメントを入力できる。

通報データは専用テーブルに保存し、運営向け管理画面で閲覧可能とする。

ブロック機能

任意ユーザーをブロックすると、以下を同時に制限する：

交換申請・マッチング対象から除外

タイムライン上でそのユーザーの投稿を非表示

自分の投稿・プロフィールを相手に見せない

ブロック状態はいつでも解除可能。

公開範囲設定

プロフィールと各投稿に対して、以下から公開範囲を選べる：

全体公開

フレンドのみ

非公開（自分だけ）

デフォルト設定は「フレンドのみ」など、ややクローズ寄りの設定を検討する。

NG 表現の制限

定型文やスタンプは、運営が用意した安全なもののみ使用可能。

自由入力欄（プロフィール紹介文など）を設ける場合は、内容をフィルタリングできる機構を別途検討する。

19.3 アカウント連携・デバイス引き継ぎ

目的
スマホの買い替えやアプリ削除後の再インストールでも、シール帳・シール・フレンド・実績が失われないようにする。

要件

ログイン手段

メールアドレス＋パスワード

SNS ログイン（例：Google, Apple など）
を少なくとも一種類以上提供し、Supabase Auth 等の仕組みで認証する。

アカウント紐付け

ゲスト状態で始めたユーザーも、後からメール／SNS を紐付けて本登録できる。

紐付け後は、異なる端末からログインしても同じデータが取得される。

データ引き継ぎ

ログイン後に取得するデータ：

プロフィール

シール帳・ページ構成

シール所持状況・ランク

交換履歴・実績・称号

同一アカウントで複数端末同時ログインした場合の挙動は、後勝ち・最新版優先など整合性が取れるポリシーを明確にする。

19.4 シール検索・タグ付け

目的
シールが大量になっても、ユーザーが目的のシールをすぐ見つけられるようにする。

要件

タグ設計

各シールのマスターデータに以下の項目を持たせる：

シリーズ名

レア度

テーマタグ：例「ネオン」「ポップ」「ゆめかわ」「地雷」「レトロ」など複数可

テーマタグは運営側で管理し、ユーザーが自由に追加する形式にはしない（タグの乱立防止）。

検索 UI

コレクション画面・交換画面共通で使用できる検索パネルを用意する。

名前テキスト検索

シリーズ選択

レア度フィルター

テーマタグのチェックボックス

絞り込み条件を保存・再利用できるようにする（例：「推しタグセット」）。

交換画面での活用

相手のシール一覧にも同様のフィルター UI を配置し、

「このテーマタグのシールだけ見せて」

「★3以上だけ見せて」
などの絞り込みが使えるようにする。

19.5 シールランクアップ＆エフェクト進化システム

（旧「シールレシピ・合成機能」を置き換え）

コンセプト
「同じシールを集めれば集めるほど、そのシールがキラキラ豪華になり、トレード価値も上がる」仕組み。
新しいシールデザインを大量に増やさなくても、育成・やり込み要素を提供できる。

19.5.1 ランクの基本仕様

ランク段階

各シールにはユーザーごとに「ランクレベル」を持たせる。

例：ランク 0〜3 または 0〜5 段階。

ランクはそのシールを「累計何枚獲得したか」で決まる。

ストックを消費するのではなく、獲得回数に応じて自動的にランクアップする。

ランクアップ条件（例）

ランク1：初めて入手（獲得数 1）

ランク2：獲得数 合計 3 枚

ランク3：獲得数 合計 6 枚

ランク4：獲得数 合計 10 枚

ランクMAX：獲得数 合計 15 枚
※具体的な数値はバランス調整で変更可能。仕様書としては「段階ごとの閾値を定義する」として扱う。

ランクとレートの関係

シールごとの「基本レート」（マスターデータの価値）に対し、

ランクレベルに応じた「ボーナスレート」を加算する。

交換画面のフェアトレード判定では、

「基本レート + ランクボーナス」を用いて価値計算を行う。

ガチャ排出確率はシールのマスターデータに基づき、ユーザーのランクによって変化させない。

19.5.2 見た目の変化（エフェクト）

ランクが上がるたびに、そのシールの表示に段階的なエフェクトを追加する：

ランク1：通常表示

ランク2：薄い光の縁取り

ランク3：キラキラのパーティクルがゆっくり流れる

ランク4：虹色のグラデーションラインが周囲に追加

ランクMAX：特別なオーラ・アニメーション、レジェンド感のある装飾

図鑑・コレクション画面・交換画面すべてでランクエフェクトが反映される。

19.5.3 ランクMAX後の重複シール

問題設定
「ランクを完全に上げた後に、同じシールをさらに引いたときの扱い」を明確にする。

仕様案

ランク上限到達後もシール自体は通常通り獲得できる。

所持枚数は増え、交換用の在庫として活用できる。

もっているシール一覧から、不要なシールを「スターポイント」に変えれる。

ポイントは以下の用途に使えるようにする：

シール帳テーマや背景の解放

特別なガチャチケットへの交換

限定アイコン・称号との交換 等

ランク値・レートには変化なし

ランクMAX 以降はそれ以上ランクは上がらず、レートも固定のままとする。

余剰分は「ポイント」「交換在庫」という形で価値を持たせ、無駄引き感を軽減する。

UI 表現

ランクMAX 後に同じシールを引いた場合、

「ランクは最大です！＋スターポイント○○GET」
のような演出を出し、プレイヤーに分かりやすく伝える。

・スターポイントへの変換は「現在の所持枚数」を減らすが、「累計獲得枚数」は減らさないため、ランクダウンは発生しない。


19.7 シール帳テーマ／スキン

目的
「シールだけでなく、シール帳そのものを着せ替える」楽しさを提供し、長期的な収集要素にする。

要件

テーマの種類

バインダーの色・素材感

ページの罫線（無地／ドット／方眼／キャラクター柄）

装飾（角金具・背表紙ラベルなど）

テーマ例：レトロ、韓国っぽ、ゆめかわ、ダーク、平成ギャル など

入手方法

ガチャの景品

イベント報酬

実績解除（一定条件達成で解放）

スターポイント（19.5）との交換
など、複数ルートを用意する。

適用単位

シール帳全体に一括適用するモード

一冊ごとに別テーマを設定できるモード（将来的拡張）

UI

プロフィールまたは設定画面に「シール帳きせかえ」セクションを用意。

所持テーマの一覧・未解放テーマのシルエット表示・解放条件などを表示する。

19.8 SNS 出力用画像エクスポート

目的
ユーザーが作ったシール帳ページを、簡単に Instagram / TikTok 等でシェアできるようにし、自然なプロモーション効果も狙う。

要件

出力対象

見開きページ単位で画像出力する。

出力比率：

正方形（1:1）

ストーリーズ／リール向け縦長（9:16）
の少なくとも2種類。

見た目

シール帳とページ全体がフレーム内に収まるよう、レイアウト専用の「撮影ビュー」を用意する。

画面の隅に「Made with ポケシル」などの小さなロゴを入れる（邪魔にならない位置・サイズ）。

技術要件（方針レベル）

ブラウザ上のページ表示を画像形式（PNG など）に変換する仕組みを利用する。

変換処理中はローディングインジケータを表示し、完了後に

画像保存

共有メニュー呼び出し
などを選べるようにする。

利用フロー

シール帳画面から「画像として保存」ボタンを押す。

比率選択（1:1 / 9:16）→ プレビュー → 保存 or 共有。

保存された画像は端末のフォトライブラリやダウンロードフォルダに格納される。

---

## 20. 実装済みシール帳機能の詳細

### 20.1 シール帳の横スクロール表示

#### 20.1.1 概要

見開きモード（isSpreadView）時に、シール帳の左ページも含めて全体を見られるように、シール帳部分が横スクロール可能になっている。

#### 20.1.2 実装構造

```tsx
{/* スクロールコンテナ（横スクロール可能） */}
<div
  ref={scrollContainerRef}
  className="relative mt-2 w-full"
  style={{
    overflowX: 'auto',
    overflowY: 'visible',
    WebkitOverflowScrolling: 'touch',  // iOS でのスムーズスクロール
    scrollbarWidth: 'thin',
  }}
>
  {/* 本のコンテナ（固定幅で中央配置） */}
  <div
    ref={bookContainerRef}
    style={{
      width: isSpreadView ? '600px' : '300px',
      minWidth: isSpreadView ? '600px' : '300px',
      marginLeft: 'auto',
      marginRight: 'auto',
    }}
  >
    <BookView ... />
  </div>
</div>
```

#### 20.1.3 コンポーネント構造

1. **scrollContainerRef**: 外側のスクロール可能なコンテナ。`overflow-x: auto` で横スクロールを有効化。
2. **bookContainerRef**: シール帳の実際のコンテナ。見開き時は 600px、単ページ時は 300px の固定幅。
3. **BookView**: react-pageflip を使用した本のコンポーネント。

#### 20.1.4 スクロール動作

- 画面幅が 600px 以下の場合、見開きシール帳は画面からはみ出し、横スクロールで左右のページを確認できる。
- iOS ではタッチスクロールがスムーズに動作するよう `-webkit-overflow-scrolling: touch` を設定。
- スクロールバーは `thin` で控えめに表示。

### 20.2 シール配置座標計算システム

#### 20.2.1 DraggableSticker のバウンド計算

シールをドラッグして配置する際、本の実際の表示領域を正確に計算する必要がある。

```typescript
const getActualBookBounds = useCallback(() => {
  if (!bookRef.current) return null
  const containerRect = bookRef.current.getBoundingClientRect()

  // 見開き状態では2ページ分の幅、そうでなければ1ページ分
  const actualBookWidth = isSpreadView ? bookWidth * 2 : bookWidth

  // 重要: コンテナ内での本の位置を計算
  // bookContainerRef の幅と actualBookWidth が異なる場合、中央配置のオフセットを計算
  const containerWidth = containerRect.width
  const horizontalOffset = (containerWidth - actualBookWidth) / 2

  // 水平方向: コンテナの左端 + 水平オフセット
  const bookLeft = containerRect.left + horizontalOffset
  const bookRight = bookLeft + actualBookWidth

  // 垂直方向: flex 構造による余白を考慮
  const topOffset = 8
  const bookTop = containerRect.top + topOffset
  const bookBottom = bookTop + bookHeight

  return {
    left: bookLeft,
    right: bookRight,
    top: bookTop,
    bottom: bookBottom,
    width: actualBookWidth,
    height: bookHeight,
  }
}, [bookRef, bookHeight, bookWidth, isSpreadView])
```

#### 20.2.2 見開きページでのシール配置判定

見開きモードでは、ドロップ位置が左ページか右ページかを判定し、正しいページにシールを配置する。

```typescript
onPlace={(x, y, rotation) => {
  if (isSpreadView) {
    // 現在のページデータから side（'left' / 'right'）を取得
    const currentPageData = demoPages[currentPage]
    const isCurrentPageRight = currentPageData?.side === 'right'

    // 左右ページのインデックスを計算
    let leftPageIndex: number
    let rightPageIndex: number

    if (isCurrentPageRight) {
      rightPageIndex = currentPage
      leftPageIndex = currentPage - 1
    } else {
      leftPageIndex = currentPage
      rightPageIndex = currentPage + 1
    }

    // x >= 0.5 なら右ページ、それ以外は左ページ
    if (x >= 0.5) {
      const adjustedX = (x - 0.5) * 2  // 0〜1 に正規化
      handlePlaceSticker(rightPageId, adjustedX, y, rotation)
    } else {
      const adjustedX = x * 2  // 0〜1 に正規化
      handlePlaceSticker(leftPageId, adjustedX, y, rotation)
    }
  } else {
    handlePlaceSticker(currentPageId, x, y, rotation)
  }
}}
```

#### 20.2.3 ページの side プロパティ

各ページデータには `side` プロパティを持たせ、見開き時にそのページが左側か右側かを明示する。

```typescript
interface PageData {
  id: string
  type: 'cover' | 'page' | 'back'
  side?: 'left' | 'right'  // 見開きモードでの位置
  // ...
}
```

---

## 21. プロフィールページの画像ベース UI

### 21.1 概要

プロフィールページでは、ゲームアプリらしい質感を出すために、PNG 画像をフレームやボタンのベースとして使用している。
これにより、CSS だけでは表現しにくいグラデーション、立体感、光沢などを自由に表現できる。

### 21.2 使用している画像アセット

すべて `public/images/` に配置：

| ファイル名 | 用途 |
|-----------|------|
| `bg_profile.png` | プロフィール画面の背景 |
| `frame_avatar_ring.png` | アバター画像の外枠リング |
| `frame_oval.png` | アバター周りの楕円フレーム |
| `level_badge.png` | レベル番号を表示するバッジ |
| `level_bar_frame.png` | 経験値バーの外枠 |
| `stat_card_frame_red.png` | 赤色のステータスカード枠 |
| `stat_card_frame_yellow.png` | 黄色のステータスカード枠 |
| `stat_card_frame_green.png` | 緑色のステータスカード枠 |
| `stat_card_frame_blue.png` | 青色のステータスカード枠 |
| `pill_button_blue.png` | 青色のピルボタン |
| `pill_button_pink.png` | ピンク色のピルボタン |
| `tabbar_ribbon.png` | 下部タブバーのリボン背景 |

### 21.3 実装パターン

#### 21.3.1 画像フレーム + コンテンツのオーバーレイ

```tsx
{/* 画像をベースにしたボタン */}
function PillButton({
  label,
  color,
  onClick
}: {
  label: string
  color: 'blue' | 'pink'
  onClick?: () => void
}) {
  const imageSrc = color === 'blue'
    ? '/images/pill_button_blue.png'
    : '/images/pill_button_pink.png'

  return (
    <button onClick={onClick} className="relative">
      {/* ボタン画像（ベース） */}
      <img
        src={imageSrc}
        alt=""
        className="w-full h-auto"
        draggable={false}
      />
      {/* テキスト（オーバーレイ） */}
      <span className="absolute inset-0 flex items-center justify-center
                       text-white font-bold text-sm">
        {label}
      </span>
    </button>
  )
}
```

#### 21.3.2 レベルバッジの実装

```tsx
{/* レベルバッジ */}
<div className="relative w-12 h-12">
  <img
    src="/images/level_badge.png"
    alt=""
    className="absolute inset-0 w-full h-full object-contain"
  />
  <span className="absolute inset-0 flex items-center justify-center
                   text-white font-bold text-lg">
    {level}
  </span>
</div>
```

#### 21.3.3 ステータスカードの実装

```tsx
{/* ステータスカード */}
function StatCard({
  value,
  label,
  color
}: {
  value: number
  label: string
  color: 'red' | 'yellow' | 'green' | 'blue'
}) {
  const frameImage = `/images/stat_card_frame_${color}.png`

  return (
    <div className="relative w-20 h-24">
      {/* カード枠画像 */}
      <img
        src={frameImage}
        alt=""
        className="absolute inset-0 w-full h-full object-contain"
      />
      {/* コンテンツ */}
      <div className="absolute inset-0 flex flex-col items-center justify-center">
        <span className="text-2xl font-bold text-white">{value}</span>
        <span className="text-xs text-white/80">{label}</span>
      </div>
    </div>
  )
}
```

### 21.4 画像ベース UI のメリット

1. **リッチな見た目**: グラデーション、光沢、立体感などを自由に表現できる
2. **デザイナーとの連携**: Figma などで作成したデザインをそのまま画像として書き出せる
3. **CSS の複雑さを回避**: 複雑なグラデーションや影は CSS で再現するより画像の方が簡単
4. **一貫したスタイル**: 同じ画像を使用することでデザインの統一感を保てる

### 21.5 注意事項

- 画像は適切なサイズに圧縮し、パフォーマンスに配慮する
- 異なる画面サイズでも崩れないよう、`object-contain` や `object-cover` を適切に使用
- テキストは画像に含めず、HTML でオーバーレイすることでアクセシビリティと多言語対応を確保
- ボタンなどインタラクティブな要素は、適切な `<button>` タグを使用してセマンティクスを維持